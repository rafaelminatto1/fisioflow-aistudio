(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[826],{67:e=>{"use strict";e.exports=require("node:async_hooks")},195:e=>{"use strict";e.exports=require("node:buffer")},623:(e,r,t)=>{"use strict";t.r(r),t.d(r,{default:()=>E});var s={};t.r(s),t.d(s,{config:()=>f,middleware:()=>h}),t(350);var n=t(137),o=t(58);class i{constructor(){this.metrics={requestCount:0,errorCount:0,errorRate:0,uptime:0,startTime:Date.now()},this.logLevel="info",this.serviceName="fisioflow",this.environment="development","undefined"!=typeof process&&process.env&&(this.logLevel=process.env.LOG_LEVEL||"info",this.serviceName=process.env.RAILWAY_SERVICE_NAME||"fisioflow",this.environment=process.env.RAILWAY_ENVIRONMENT||"production")}shouldLog(e){let r=["debug","info","warn","error"];return r.indexOf(e)>=r.indexOf(this.logLevel)}formatLog(e){let{level:r,message:t,timestamp:s,metadata:n,error:o}=e;return JSON.stringify({timestamp:s,level:r.toUpperCase(),service:this.serviceName,environment:this.environment,message:t,...n&&{metadata:n},...o&&{error:{name:o.name,message:o.message,stack:o.stack}}})}log(e,r,t,s){if(!this.shouldLog(e))return;let n={level:e,message:r,timestamp:new Date().toISOString(),metadata:s,error:t},o=this.formatLog(n);switch(e){case"debug":case"info":break;case"warn":console.warn(o);break;case"error":console.error(o),this.metrics.errorCount++}this.updateMetrics()}updateMetrics(){this.metrics.requestCount++,this.metrics.uptime=Date.now()-this.metrics.startTime,this.metrics.errorRate=this.metrics.requestCount>0?this.metrics.errorCount/this.metrics.requestCount*100:0}debug(e,r){this.log("debug",e,void 0,r)}info(e,r){this.log("info",e,void 0,r)}warn(e,r){this.log("warn",e,void 0,r)}error(e,r,t){this.log("error",e,r,t)}getMetrics(){return{...this.metrics,uptime:Date.now()-this.metrics.startTime}}createRequestMiddleware(){return e=>{let r=Date.now(),t=Math.random().toString(36).substring(7);return this.info("Requisi\xe7\xe3o recebida",{requestId:t,method:e.method,url:e.url,userAgent:e.headers.get("user-agent"),ip:e.headers.get("x-forwarded-for")||"unknown"}),(s,n)=>{let o=Date.now()-r;n?this.error("Erro na requisi\xe7\xe3o",n,{requestId:t,status:s,duration:o,method:e.method,url:e.url}):this.info("Resposta enviada",{requestId:t,status:s,duration:o,method:e.method,url:e.url})}}}measurePerformance(e,r){let t=Date.now();try{let s=r();if(s instanceof Promise)return s.then(r=>{let s=Date.now()-t;return this.debug(`Performance: ${e}`,{duration:s}),r}).catch(r=>{let s=Date.now()-t;throw this.error(`Performance error: ${e}`,r,{duration:s}),r});{let r=Date.now()-t;return this.debug(`Performance: ${e}`,{duration:r}),s}}catch(s){let r=Date.now()-t;throw this.error(`Performance error: ${e}`,s,{duration:r}),s}}}let a=new i,c={rateLimit:{enabled:"true"===("undefined"!=typeof process&&process.env?.RATE_LIMIT_ENABLED),windowMs:parseInt("undefined"!=typeof process&&process.env?.RATE_LIMIT_WINDOW||"900000"),maxRequests:parseInt("undefined"!=typeof process&&process.env?.RATE_LIMIT_MAX_REQUESTS||"100")},cors:{enabled:"true"===("undefined"!=typeof process&&process.env?.CORS_ENABLED),origins:"undefined"!=typeof process&&process.env?.CORS_ORIGINS?.split(",")||["*"],methods:"undefined"!=typeof process&&process.env?.CORS_METHODS?.split(",")||["GET","POST","PUT","DELETE","OPTIONS"],headers:"undefined"!=typeof process&&process.env?.CORS_HEADERS?.split(",")||["Content-Type","Authorization"]},healthCheck:{enabled:"true"===("undefined"!=typeof process&&process.env?.HEALTH_CHECK_ENABLED),path:"undefined"!=typeof process&&process.env?.HEALTH_CHECK_PATH||"/health"},security:{helmet:"true"===("undefined"!=typeof process&&process.env?.HELMET_ENABLED),csrf:"true"===("undefined"!=typeof process&&process.env?.CSRF_PROTECTION)}},u=new Map;function d(e,r){if(!c.cors.enabled)return e;let t=r.headers.get("origin"),{origins:s,methods:n,headers:o}=c.cors;return(s.includes("*")||t&&s.includes(t))&&e.headers.set("Access-Control-Allow-Origin",t||"*"),e.headers.set("Access-Control-Allow-Methods",n.join(", ")),e.headers.set("Access-Control-Allow-Headers",o.join(", ")),e.headers.set("Access-Control-Allow-Credentials","true"),e.headers.set("Access-Control-Max-Age","86400"),e}function l(e){return c.security.helmet&&(e.headers.set("X-Content-Type-Options","nosniff"),e.headers.set("X-Frame-Options","DENY"),e.headers.set("X-XSS-Protection","1; mode=block"),e.headers.set("Referrer-Policy","strict-origin-when-cross-origin"),e.headers.set("Permissions-Policy","camera=(), microphone=(), geolocation=()"),e.headers.set("Content-Security-Policy","default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https://api.neon.tech https://*.railway.app; frame-ancestors 'none'")),e}async function h(e){return a.measurePerformance("middleware_execution",async()=>{let r=Date.now(),t=a.createRequestMiddleware()(e);try{let s=function(e){if(!c.healthCheck.enabled)return null;let{pathname:r}=new URL(e.url);if(r===c.healthCheck.path){let r=a.getMetrics(),t={status:"healthy",timestamp:new Date().toISOString(),uptime:r.uptime,environment:process.env.RAILWAY_ENVIRONMENT||"production",service:process.env.RAILWAY_SERVICE_NAME||"fisioflow",version:process.env.npm_package_version||"1.0.0",commit:process.env.RAILWAY_GIT_COMMIT_SHA,deploymentId:process.env.RAILWAY_DEPLOYMENT_ID,metrics:{requestCount:r.requestCount,errorCount:r.errorCount,errorRate:r.errorRate,uptime:r.uptime},checks:{database:"healthy",redis:"healthy"}};return a.info("Health check executado",{ip:e.headers.get("x-forwarded-for")||"unknown",userAgent:e.headers.get("user-agent")}),o.xk.json(t,{status:200,headers:{"Cache-Control":"no-cache, no-store, must-revalidate","Content-Type":"application/json"}})}return null}(e);if(s)return t(200),s;if(!function(e){if(!c.rateLimit.enabled)return!0;let r=e.headers.get("x-forwarded-for")||e.headers.get("x-real-ip")||"unknown",t=Date.now(),s=c.rateLimit.windowMs,n=c.rateLimit.maxRequests;.01>Math.random()&&function(){let e=Date.now();for(let[r,t]of Array.from(u.entries()))e>t.resetTime&&u.delete(r)}();let o=`rate_limit:${r}`,i=u.get(o);return!i||t>i.resetTime?(u.set(o,{count:1,resetTime:t+s}),!0):!(i.count>=n)&&(i.count++,!0)}(e)){a.warn("Rate limit excedido",{ip:e.headers.get("x-forwarded-for")||"unknown",userAgent:e.headers.get("user-agent"),url:e.url});let r=o.xk.json({error:"Rate limit exceeded"},{status:429});return t(429),d(l(r),e)}if("OPTIONS"===e.method){let r=new o.xk(null,{status:200});return t(200),d(l(r),e)}let n=o.xk.next(),i=d(l(n),e);i.headers.set("X-Railway-Service",process.env.RAILWAY_SERVICE_NAME||"fisioflow"),i.headers.set("X-Railway-Environment",process.env.RAILWAY_ENVIRONMENT||"development"),process.env.RAILWAY_DEPLOYMENT_ID&&i.headers.set("X-Railway-Deployment",process.env.RAILWAY_DEPLOYMENT_ID);let h=Date.now()-r;return t(i.status),h>1e3&&a.warn("Requisi\xe7\xe3o lenta detectada",{url:e.url,method:e.method,duration:h}),i}catch(s){a.error("Erro no middleware",s,{url:e.url,method:e.method,userAgent:e.headers.get("user-agent")});let r=o.xk.json({error:"Internal server error"},{status:500});return t(500,s),d(l(r),e)}})}let f={matcher:["/((?!_next/static|_next/image|favicon.ico|public/).*)"]},p={...s},m=p.middleware||p.default,w="/middleware";if("function"!=typeof m)throw Error(`The Middleware "${w}" must export a \`middleware\` or a \`default\` function`);function E(e){return(0,n.C)({...e,page:w,handler:m})}}},e=>{var r=r=>e(e.s=r);e.O(0,[216],()=>r(623));var t=e.O();(_ENTRIES="undefined"==typeof _ENTRIES?{}:_ENTRIES).middleware_middleware=t}]);
//# sourceMappingURL=middleware.js.map