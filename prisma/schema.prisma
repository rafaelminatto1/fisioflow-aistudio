generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearch", "postgresqlExtensions"]
  binaryTargets   = ["native", "rhel-openssl-1.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                String             @id @default(cuid())
  name              String
  email             String             @unique
  passwordHash      String?            @map("password_hash")
  role              Role
  avatarUrl         String?            @map("avatar_url")
  createdAt         DateTime           @default(now()) @map("created_at")
  updatedAt         DateTime           @updatedAt @map("updated_at")
  appointments      Appointment[]
  communicationLogs CommunicationLog[]

  @@map("users")
}

model Patient {
  id                String             @id @default(cuid())
  name              String
  cpf               String             @unique
  email             String?
  phone             String?
  birthDate         DateTime?          @map("birth_date")
  address           Json?
  emergencyContact  Json?              @map("emergency_contact")
  status            PatientStatus      @default(Active)
  lastVisit         DateTime?          @map("last_visit")
  allergies         String?
  medicalAlerts     String?            @map("medical_alerts")
  consentGiven      Boolean            @default(false) @map("consent_given")
  whatsappConsent   WhatsAppConsent    @default(opt_out) @map("whatsapp_consent")
  createdAt         DateTime           @default(now()) @map("created_at")
  updatedAt         DateTime           @updatedAt @map("updated_at")
  appointments      Appointment[]
  communicationLogs CommunicationLog[]
  metricResults     MetricResult[]
  painPoints        PainPoint[]

  @@map("patients")
}

model Appointment {
  id            String            @id @default(cuid())
  patientId     String            @map("patient_id")
  therapistId   String            @map("therapist_id")
  startTime     DateTime          @map("start_time")
  endTime       DateTime          @map("end_time")
  type          AppointmentType
  status        AppointmentStatus @default(Agendado)
  value         Decimal?          @db.Decimal(10, 2)
  paymentStatus PaymentStatus     @default(pending) @map("payment_status")
  observations  String?
  seriesId      String?           @map("series_id")
  sessionNumber Int?              @map("session_number")
  totalSessions Int?              @map("total_sessions")
  createdAt     DateTime          @default(now()) @map("created_at")
  patient       Patient           @relation(fields: [patientId], references: [id], onDelete: Cascade)
  therapist     User              @relation(fields: [therapistId], references: [id], onDelete: Cascade)
  soapNotes     SoapNote[]

  @@index([patientId])
  @@index([therapistId])
  @@index([startTime])
  @@map("appointments")
}

model PainPoint {
  id          String   @id @default(cuid())
  patientId   String   @map("patient_id")
  xPosition   Float    @map("x_position")
  yPosition   Float    @map("y_position")
  intensity   Int      @db.SmallInt
  type        PainType
  description String?
  bodyPart    BodyPart @map("body_part")
  createdAt   DateTime @default(now()) @map("created_at")
  patient     Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([createdAt(sort: Desc)])
  @@map("pain_points")
}

model MetricResult {
  id         String   @id @default(cuid())
  patientId  String   @map("patient_id")
  metricName String   @map("metric_name")
  value      Float
  unit       String
  measuredAt DateTime @default(now()) @map("measured_at")
  patient    Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([measuredAt(sort: Desc)])
  @@map("metric_results")
}

model SoapNote {
  id            String      @id @default(cuid())
  appointmentId String      @map("appointment_id")
  subjective    String?
  objective     String?
  assessment    String?
  plan          String?
  createdAt     DateTime    @default(now()) @map("created_at")
  appointment   Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)

  @@map("soap_notes")
}

model CommunicationLog {
  id        String            @id @default(cuid())
  patientId String            @map("patient_id")
  userId    String            @map("user_id")
  type      CommunicationType
  notes     String
  createdAt DateTime          @default(now()) @map("created_at")
  patient   Patient           @relation(fields: [patientId], references: [id], onDelete: Cascade)
  user      User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([createdAt(sort: Desc)])
  @@map("communication_logs")
}

enum Role {
  Admin
  Fisioterapeuta
  Paciente
  EducadorFisico
}

enum AppointmentType {
  Avaliacao
  Sessao
  Retorno
  Pilates
  Urgente
  Teleconsulta
}

enum AppointmentStatus {
  Agendado
  Realizado
  Concluido
  Cancelado
  Faltou
}

enum PaymentStatus {
  paid
  pending
}

enum PatientStatus {
  Active
  Inactive
  Discharged
}

enum PainType {
  latejante
  aguda
  queimacao
  formigamento
  cansaco
}

enum BodyPart {
  front
  back
}

enum CommunicationType {
  WhatsApp
  Ligacao
  Email
  Outro
}

enum WhatsAppConsent {
  opt_in
  opt_out
}
